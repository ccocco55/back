<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.youeatieat.mapper.CategoriesProductMapper">
    <!-- 가격 필터 -->
    <sql id="priceFilter">
        <if test="search.priceKeyword != null and search.priceKeyword != ''">
            <choose>
                <when test="search.priceKeyword == '1000'">
                    and product_price &lt;= 1000
                </when>
                <when test="search.priceKeyword == '2000'">
                    and product_price &gt;= 1000 and product_price &lt;= 2000
                </when>
                <when test="search.priceKeyword == '3000'">
                    and product_price &gt;= 2000 and product_price &lt;= 3000
                </when>
                <when test="search.priceKeyword == '4000'">
                    and product_price &gt;= 4000 and product_price &lt;= 5000
                </when>
                <when test="search.priceKeyword == '5000'">
                    and product_price &gt;= 5000
                </when>
            </choose>
        </if>
    </sql>

    <!-- 카테고리 조회 -->
    <select id="selectList">
        select id, product_name, product_price, product_quantity, product_title_image_url, product_info_image_url, product_min_number, product_status, created_date, main_category_id, sub_category_name
        from tbl_product
        where product_status = 'active'
        and main_category_id = #{id}
        <if test="search.subCategoryName != null and search.priceKeyword != ''">
            and sub_category_name = #{search.subCategoryName}
        </if>
        <include refid="priceFilter"/>
        <choose>
            <when test="search.keyword == 'latest'">
                order by created_date desc
            </when>
            <when test="search.keyword == 'priceHigh'">
                order by product_price desc
            </when>
            <when test="search.keyword == 'priceLow'">
                order by product_price asc
            </when>
            <otherwise>
                order by created_date desc
            </otherwise>
        </choose>
        limit #{criteria.rowCount} offset #{criteria.offset}
    </select>


<!--  아이디로 상품 조회  -->
    <select id="selectById">
        select id, product_name, product_price, product_quantity,
               product_title_image_url, product_info_image_url, product_min_number,
               product_status, created_date, updated_date,
               main_category_id, main_category_name,
               sub_category_id, sub_category_name
        from view_best_product_detail
        where id = #{id}
    </select>

    <!-- 개수 조회-->
    <select id="countProduct">
        select count(*)
        from tbl_product
        where product_status = 'active'
        and main_category_id = #{id}
        <if test="search.subCategoryName != null and search.priceKeyword != ''">
            and sub_category_name = #{search.subCategoryName}
        </if>
        <include refid="priceFilter"/>
    </select>
</mapper>