<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.youeatieat.mapper.BestProductMapper">
    <!-- 대카 검색 -->
    <sql id="search">
        <if test="search.mainCategories != null and search.mainCategories.size() > 0">
            and
            <trim suffixOverrides="or" prefix="(" suffix=")">
                <foreach item="category" collection="search.mainCategories">
                    main_category_name = #{category} or
                </foreach>
            </trim>
        </if>
    </sql>

    <!-- 가격 필터 -->
    <sql id="priceFilter">
        <if test="search.priceKeyword != null">
            <choose>
                <when test="search.priceKeyword == '1000'">
                    and product_price &lt;= 1000
                </when>
                <when test="search.priceKeyword == '2000'">
                    and product_price &gt;= 1000 and product_price &lt;= 2000
                </when>
                <when test="search.priceKeyword == '3000'">
                    and product_price &gt;= 2000 and product_price &lt;= 3000
                </when>
                <when test="search.priceKeyword == '4000'">
                    and product_price &gt;= 4000 and product_price &lt;= 5000
                </when>
                <when test="search.priceKeyword == '5000'">
                    and product_price &gt;= 5000
                </when>
            </choose>
        </if>
    </sql>

    <!-- 신상품 조회 -->
    <select id="selectList">
        select id, product_name, product_price, product_quantity,
        product_title_image_url, product_info_image_url, product_min_number,
        product_status, created_date, updated_date,
        main_category_id, main_category_name,
        sub_category_id, sub_category_name, like_count
        from view_best_product_detail
        where product_status = 'active'
        <include refid="search"/>
        <include refid="priceFilter"/>
        order by like_count desc
        limit #{criteria.rowCount} offset #{criteria.offset}
    </select>


<!--  아이디로 상품 조회  -->
    <select id="selectById">
        select id, product_name, product_price, product_quantity,
               product_title_image_url, product_info_image_url, product_min_number,
               product_status, created_date, updated_date,
               main_category_id, main_category_name,
               sub_category_id, sub_category_name
        from view_best_product_detail
        where id = #{id}
    </select>

    <!-- 개수 조회-->
    <select id="countProduct">
        select count(*)
        from view_best_product_detail
        where product_status = 'active'
        <include refid="search"/>
        <include refid="priceFilter"/>
    </select>
</mapper>