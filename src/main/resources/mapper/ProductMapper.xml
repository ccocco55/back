<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.youeatieat.mapper.ProductMapper">
    <!-- 대카 검색 -->
    <sql id="search">
        <if test="search.mainCategories != null">
            and main_category_name in
            <foreach item="category" collection="search.mainCategories" open="(" separator="," close=")">
                #{category}
            </foreach>
        </if>
    </sql>

    <!-- 가격 필터 -->
    <sql id="priceFilter">
        <if test="search.priceKeyword != null">
            <choose>
                <when test="search.priceKeyword == 'RANGE_1'">
                    and product_price &lt;= 10000
                </when>
                <when test="search.priceKeyword == 'RANGE_2'">
                    and product_price &gt;= 10000 and product_price &lt;= 30000
                </when>
                <when test="search.priceKeyword == 'RANGE_3'">
                    and product_price &gt;= 30000 and product_price &lt;= 50000
                </when>
                <when test="search.priceKeyword == 'RANGE_4'">
                    and product_price &gt;= 50000
                </when>
            </choose>
        </if>
    </sql>

    <!-- 신상품 조회 -->
    <select id="selectList">
        select id, product_name, product_price, product_quantity,
        product_title_image_url, product_info_image_url, product_min_number,
        product_status, created_date, updated_date,
        main_category_id, main_category_name,
        sub_category_id, sub_category_name
        from view_product_detail
        where product_status = 'active'
        <include refid="search"/>
        <include refid="priceFilter"/>
        order by created_date desc
        limit #{criteria.rowCount} offset #{criteria.offset}
    </select>


<!--  아이디로 상품 조회  -->
    <select id="selectById">
        select id, product_name, product_price, product_quantity,
               product_title_image_url, product_info_image_url, product_min_number,
               product_status, created_date, updated_date,
               main_category_id, main_category_name,
               sub_category_id, sub_category_name
        from view_product_detail
        where id = #{id}
    </select>

    <!-- 개수 조회-->
    <select id="countProduct">
        select count(*)
        from view_product_detail
        where product_status = 'active'
        <include refid="search"/>
        <include refid="priceFilter"/>
    </select>
</mapper>